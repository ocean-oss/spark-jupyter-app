---
ocean:
  version: "1"
steps:
  - engines:
    - name: spark-master
      vars:
        - name: private_ip
          value: "{{ engines.spark-master.deployment.nodes.main.private_ip }}"
        - name: port
          value: "{% reserve_public_port %}"
        - name: dashboard_port
          value: "{% reserve_public_port %}"
        - name: url
          value: "spark://{{ engines.spark-master.vars.private_ip }}:{{ engines.spark-master.vars.port }}"
      orchestrator:
        type: Orchestrator::MainWithWorkers
        deploy_to_main: true
        deploy_to_workers: false
        snapshot:
          registry:
            name: docker_hub
          image:
            name: jupyter/all-spark-notebook
          name: latest
        container:
          user: root
          workdir: /work
          mounts:
            engine: /etc/ocean
            data_stores: "{{ engines.spark-master.orchestrator.container.workdir }}"
            ssh: "/home/{{ workspace.user.name }}/.ssh"
          nodes:
            main:
              command: "{{ engines.spark-master.orchestrator.container.mounts.engine }}/startup.sh"
              env_vars:
                - name: SPARK_NO_DAEMONIZE
                  value: true
      ui:
        buttons:
          - node_target: main
            label: Spark Master Dashboard
            url: "http://{{ engines.spark-master.ui.buttons.self.node.public_ip }}:{{ engines.spark-master.vars.dashboard_port }}"
  - engines:
      - name: spark-worker
        vars:
          - name: port
            value: "{% reserve_public_port %}"
          - name: dashboard_port
            value: "{% reserve_public_port %}"
        orchestrator:
          type: Orchestrator::MainWithWorkers
          deploy_to_main: false
          deploy_to_workers: true
          snapshot:
            registry:
              name: docker_hub
            image:
              name: jupyter/all-spark-notebook
            name: latest
          container:
            user: root
            workdir: /work
            mounts:
              engine: /etc/ocean
              data_stores: "{{ engines.spark-worker.orchestrator.container.workdir }}"
              ssh: "/home/{{ workspace.user.name }}/.ssh"
            nodes:
              worker:
                command: "{{ engines.spark-worker.orchestrator.container.mounts.engine }}/startup.sh"
                env_vars:
                  - name: SPARK_NO_DAEMONIZE
                    value: true
        ui:
          buttons:
            - node_target: workers
              label: Spark Worker Dashboard
              url: "http://{{ engines.spark-worker.ui.buttons.self.node.public_ip }}:{{ engines.spark-worker.vars.dashboard_port }}"
  - engines:
    - name: jupyter
      vars:
        - name: jupyter_port
          value: "{% reserve_public_port %}"
        - name: jupyter_token
          value: "{% generate_uuid %}"
      orchestrator:
        type: Orchestrator::MainWithWorkers
        deploy_to_main: true
        deploy_to_workers: false
        snapshot:
          registry:
            name: docker_hub
          image:
            name: jupyter/all-spark-notebook
          name: latest
        container:
          user: root
          workdir: /work
          mounts:
            engine: /etc/ocean
            data_stores: "{{ engines.jupyter.orchestrator.container.workdir }}"
            ssh: "/home/{{ workspace.user.name }}/.ssh"
          nodes:
            main:
              command: "{{ engines.jupyter.orchestrator.container.mounts.engine }}/startup.sh"
              env_vars:
                - name: JUPYTER_ENABLE_LAB
                  value: yes
                - name: NB_UID
                  value: "{{ workspace.user.uid }}"
                - name: NB_GID
                  value: "{{ workspace.user.gid }}"
                - name: CHOWN_HOME
                  value: yes
                - name: GRANT_SUDO
                  value: yes
                - name: RESTARTABLE
                  value: yes
                - name: SPARK_MASTER
                  value: "{{ engines.spark-master.vars.url }}"
      ui:
        buttons:
          - node_target: main
            label: Jupyter Notebook
            url: "http://{{ engines.jupyter.ui.buttons.self.node.public_ip }}:{{ engines.jupyter.vars.jupyter_port }}?token={{ engines.jupyter.vars.jupyter_token }}"